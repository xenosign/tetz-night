<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Opengraph -->
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="이효석의 밤 초대장" />
    <meta property="og:title" content="이효석의 밤 초대장" />
    <meta
      property="og:description"
      content="여러분은 이효석의 밤에 초대 되셨습니다.참여하시겠습니까?"
    />
    <meta
      property="og:image"
      content="https://tetz-night.netlify.app/tetz_invitation.png"
    />
    <meta property="og:url" content="https://tetz-night.netlify.app/" />

    <!-- Twittercard -->
    <meta property="twitter:card" content="summary" />
    <meta property="twitter:site" content="이효석의 밤 초대장" />
    <meta property="twitter:title" content="이효석의 밤 초대장" />
    <meta
      property="twitter:description"
      content="여러분은 이효석의 밤에 초대 되셨습니다.참여하시겠습니까?"
    />
    <meta
      property="twitter:image"
      content="https://tetz-night.netlify.app/tetz_invitation.png"
    />

    <title>Tetz's Night!</title>

    <link rel="icon" type="image/x-icon" href="./favicon.ico" />
    <link rel="stylesheet" href="./style.css" />
  </head>
  <body>
    <div class="main">
      <div class="invitation">
        <h1>✉️이효석의 밤, 초대장</h1>
        <h2>Invitation for Tetz's night!</h2>
        <br />
        <img class="main-img" src="./tetz_invitation.png" />
        <h3 class="margin-top">(Thanks for 규찬 ㅋㅋㅋㅋㅋ)</h3>

        <br />
        <div class="info">
          <div>
            <h2>🎈일시 : 2025년 2월 15일, 토요일 5시</h2>
          </div>
          <br />
          <br />
          <div>
            <h2>🎈장소 : 서울 어딘가(미정)</h2>
            <h3 class="margin-top">참여 인원에 따라 변동이 있을 예정입니다!</h3>
            <h3 class="margin-top">
              투표로 인원이 확정되면 바로 장소 업데이트 후,<br />
              안내 드릴 예정입니다!
            </h3>
            <h3 class="margin-top">투표 해주세요~ 꼭이요!</h3>
          </div>
          <br />
          <br />
          <div>
            <h2>🎈참여자 : Tetz 의 수업을 들었던 분들</h2>
            <h3 class="margin-top">
              코딩온 KDT 1기, KDT 5기, KB It's your life 5기 +@
            </h3>
          </div>
          <br />
          <br />
          <div>
            <h2>🎈참가비 : 2만원</h2>
            <h3 class="margin-top">
              참가비는 그날 먹고 마시는데 사용될 예정입니다!<br />
              장소 대여 비용은 Tetz 가 쏩니다! 😁
            </h3>
          </div>
          <br />
          <br />
          <div>
            <h2>🎈무얼 하나요?</h2>
            <h3 class="margin-top">참여자들 간의 네트워킹</h3>
            <h3 class="margin-top">테츠 퀴즈 풀기 & 상품 전달</h3>
            <h3 class="margin-top">레크레이션 및 한 줄 게시판 아이디어 진행</h3>
            <h3 class="margin-top">재미있게 놀기 😁🤣😄😎🤗😏😝😇🤮</h3>
            <h3 class="margin-top">🍺🍾🍸🍷🍹🥂🍻🍺</h3>
          </div>
        </div>
      </div>
      <hr />
      <div class="vote">
        <h1>😎이효석의 밤 오시겠습니까?</h1>
        <h2>Would you like to join Tetz's night?</h2>
        <br />
        <h3 class="margin-top">
          투표는 단순히 참여 인원을 확인하기 위해 만들었습니다<br />
          브라우저별 랜덤 uuid를 생성하여<br />
          저도 투표자가 누구인지 절대 알 수 없습니다!<br />
        </h3>
        <h3 class="margin-top">그러니 편한 마음으로 투표 해주세요!</h3>
        <h3 class="margin-top">
          대신 정확한 인원 파악을 위해<br />
          브라우저를 변경하시면서 중복 투표는 참아주세요 😅
        </h3>

        <div class="button-container">
          <button id="attend-btn" class="btn">참여</button>
          <button id="decline-btn" class="btn">불참</button>
          <button id="modify-btn" class="btn" style="display: none">
            참여 여부 수정
          </button>
        </div>
        <br />
        <h1>현재 참여자 : <span id="attendCount">0</span></h1>
      </div>
      <hr />
      <div class="chat">
        <h1>🤼이효석의 밤 참여자들과<br />소통하고 싶으신가요?</h1>
        <h2>Would you like to talk?</h2>
        <br />
        <h3>
          채팅이 하고 싶으시면 아래 버튼을 클릭해서<br />
          크롬 익스텐션을 설치하시면<br />
          초대장을 받은 사람들끼리 채팅이 가능합니다.<br />
          (같이 개발한 사람 : 호준님, 경은님)
        </h3>
        <br />
        <a
          href="https://chromewebstore.google.com/detail/web-chat/hialhgiplaekafjncddejnpdbgpjgknf?hl=ko"
          target="_blank"
        >
          <button id="extension-btn" class="btn">
            크롬 익스텐션 바로 가기
          </button>
        </a>
      </div>
      <hr />
      <div class="board">
        <h1>📝이효석에 밤에 대해<br />하고 싶은 말을 남겨주세요!</h1>
        <h2>Please leave a message!</h2>
        <br />
        <h3 class="margin-top">
          편하게 작성 하시면 됩니다!<br />
          이효석의 밤에서 하고 싶은<br />
          레크레이션이나 아이디어도 좋습니다!<br />
        </h3>
        <h3 class="margin-top">
          가장 많이 좋아요를 받은 아이디어는<br />
          당일 진행 예정입니다 🫡
        </h3>
        <br />
        <div class="post-form">
          <input
            type="text"
            id="post-content"
            placeholder="메시지를 입력하세요. 최대 40자!"
            maxlength="40"
            oninput="this.value=this.value.slice(0,40)"
          />
          <button id="post-btn" class="btn">작성</button>
        </div>
        <br />
        <div id="posts-container"></div>
      </div>
    </div>

    <script>
      const attendBtn = document.getElementById('attend-btn');
      const declineBtn = document.getElementById('decline-btn');
      const modifyBtn = document.getElementById('modify-btn');
      const voteButtons = document.querySelector('.button-container');
      const postBtn = document.getElementById('post-btn');
      const postContent = document.getElementById('post-content');
      const postsContainer = document.getElementById('posts-container');

      // const BASE_URL = "http://localhost:8080";
      const BASE_URL =
        'https://port-0-tetz-night-back-m5yo5gmx92cc34bc.sel4.cloudtype.app';

      let userId;

      // UUID 생성 함수
      const generateUUID = () => {
        return (
          'uuid-' +
          Math.random().toString(36).substr(2, 6) +
          '-' +
          Math.random().toString(36).substr(2, 3)
        );
      };

      // 로컬스토리지 체크
      const checkVoteStatus = () => {
        const hasVoted = localStorage.getItem('tetzNightVote');
        if (hasVoted) {
          attendBtn.style.display = 'none';
          declineBtn.style.display = 'none';
          modifyBtn.style.display = 'block';
        }
      };

      // UUID 체크 및 생성
      const checkAndGenerateUUID = () => {
        userId = localStorage.getItem('tetzNightUserId');
        if (!userId) {
          userId = generateUUID();
          localStorage.setItem('tetzNightUserId', userId);
        }
        return userId;
      };

      // 초기 로드시 체크
      checkVoteStatus();
      checkAndGenerateUUID();

      // 참여 버튼 클릭
      attendBtn.addEventListener('click', async () => {
        const userId = localStorage.getItem('tetzNightUserId');

        try {
          const response = await fetch(`${BASE_URL}/vote`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              user: userId,
              voteType: '참여',
            }),
          });

          if (response.status === 200) {
            localStorage.setItem('tetzNightVote', 'attend');
            checkVoteStatus();
            loadVotes();
          } else {
            alert(
              '죄송 합니다. 백엔드 서버가 죽었습니다 ㅠㅠ\n빠르게 수정 하겠습니다 by tetz'
            );
            throw new Error('투표 전송 실패');
          }
        } catch (error) {
          alert(
            '죄송 합니다. 백엔드 서버가 죽었습니다 ㅠㅠ\n빠르게 수정 하겠습니다 by tetz'
          );
          console.error('투표 전송 중 오류 발생:', error);
        }
      });

      // 불참 버튼 클릭
      declineBtn.addEventListener('click', async () => {
        try {
          const response = await fetch(`${BASE_URL}/vote`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              user: userId,
              voteType: '불참',
            }),
          });

          if (response.status === 200) {
            localStorage.setItem('tetzNightVote', 'decline');
            checkVoteStatus();
            loadVotes();
          } else {
            alert(
              '죄송 합니다. 백엔드 서버가 죽었습니다 ㅠㅠ\n빠르게 수정 하겠습니다 by tetz'
            );
            throw new Error('투표 전송 실패');
          }
        } catch (error) {
          alert(
            '죄송 합니다. 백엔드 서버가 죽었습니다 ㅠㅠ\n빠르게 수정 하겠습니다 by tetz'
          );
          console.error('투표 전송 중 오류 발생:', error);
        }
      });

      // 수정 버튼 클릭
      modifyBtn.addEventListener('click', () => {
        localStorage.removeItem('tetzNightVote');
        attendBtn.style.display = 'block';
        declineBtn.style.display = 'block';
        modifyBtn.style.display = 'none';
      });

      // 투표 현황 불러오기
      const loadVotes = async () => {
        try {
          const response = await fetch(`${BASE_URL}/vote`);
          const votes = await response.json();
          const attendCount = document.getElementById('attendCount');
          attendCount.textContent = `${votes.attend}명`;
        } catch (error) {
          console.error('투표 수 로딩 중 오류 발생:', error);
          attendCount.textContent = '서버 오류';
        }
      };

      // 게시글 불러오기
      const loadPosts = async () => {
        try {
          const response = await fetch(`${BASE_URL}/post`, {
            headers: {
              uuid: userId,
            },
          });
          const posts = await response.json();

          postsContainer.innerHTML = posts
            .map(
              (post) => `
            <div class="post">
              <span class="post-user" style="font-size: 20px">✏️ ${post.user.replace(
                'uuid-',
                ''
              )} | </span>
              <span class="post-content" style="font-size: 20px">${
                post.content.includes('onerror')
                  ? post.content.replace(/[<>]/g, (match) =>
                      match === '<' ? '&lt;' : '&gt;'
                    )
                  : post.content
              }</span>
              <button id="like-btn" class="btn" onclick="likePost('${post.id}')"
                style="background: ${
                  post.liked
                    ? 'linear-gradient(45deg, #ff1493, #ff69b4)'
                    : 'linear-gradient(45deg, #808080, #a9a9a9)'
                }; font-size: 20px">
                👍 <span class="like-count">${post.likeCount || 0}</span>
              </button>
            </div>
          `
            )
            .join('');
        } catch (error) {
          console.error('게시글 로딩 중 오류 발생:', error);
          postsContainer.innerHTML =
            '<h3 style="text-align: center; color: white;">죄송합니다. 백엔드 서버가 죽었어요 ㅠㅠ</h3>';
        }
      };

      // 게시글 작성
      postBtn.addEventListener('click', async () => {
        const content = postContent.value;

        if (!content) {
          alert('내용을 입력해주세요!');
          return;
        }

        try {
          const response = await fetch(`${BASE_URL}/post`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              user: userId,
              content,
            }),
          });

          if (response.status === 201) {
            postContent.value = ''; // 작성 완료 후 input 비우기
            loadPosts();
          } else {
            alert(
              '죄송 합니다. 백엔드 서버가 죽었습니다 ㅠㅠ\n빠르게 수정 하겠습니다 by tetz'
            );
          }
        } catch (error) {
          console.error('게시글 작성 중 오류 발생:', error);
          alert(
            '죄송 합니다. 백엔드 서버가 죽었습니다 ㅠㅠ\n빠르게 수정 하겠습니다 by tetz'
          );
        }
      });

      // 엔터키로 게시글 작성
      postContent.addEventListener('keypress', async (e) => {
        if (e.key === 'Enter') {
          const content = postContent.value;

          if (!content) {
            alert('내용을 입력해주세요!');
            return;
          }

          try {
            const response = await fetch(`${BASE_URL}/post`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                user: userId,
                content,
              }),
            });

            if (response.status === 201) {
              postContent.value = ''; // 작성 완료 후 input 비우기
              loadPosts();
            } else {
              alert(
                '죄송 합니다. 백엔드 서버가 죽었습니다 ㅠㅠ\n빠르게 수정 하겠습니다 by tetz'
              );
            }
          } catch (error) {
            console.error('게시글 작성 중 오류 발생:', error);
            alert(
              '죄송 합니다. 백엔드 서버가 죽었습니다 ㅠㅠ\n빠르게 수정 하겠습니다 by tetz'
            );
          }
        }
      });

      // 게시글 좋아요
      const likePost = async (postId) => {
        try {
          const response = await fetch(`${BASE_URL}/${postId}/like`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              uuid: userId,
            },
          });

          if (response.status === 200) {
            loadPosts();
          } else {
            alert(
              '죄송 합니다. 백엔드 서버가 죽었습니다 ㅠㅠ\n빠르게 수정 하겠습니다 by tetz'
            );
          }
        } catch (error) {
          console.error('좋아요 중 오류 발생:', error);
          alert(
            '죄송 합니다. 백엔드 서버가 죽었습니다 ㅠㅠ\n빠르게 수정 하겠습니다 by tetz'
          );
        }
      };

      // 초기 게시글 로딩
      loadPosts();
      loadVotes();
    </script>
  </body>
</html>
